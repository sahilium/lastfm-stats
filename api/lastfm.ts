import type {
	VercelRequest,
	VercelResponse
} from "vercel"

const PLACEHOLDER =
"data:image/svg+xml;utf8," +
encodeURIComponent(`
	<svg viewBox="78.69999694824219 53.9000129699707 204.6999969482422 204.30003356933594" width="204.6999969482422" height="204.30003356933594" xmlns="http://www.w3.org/2000/svg"><g transform="matrix(1, 0, 0, 1, 0, 0)"><g transform="matrix(1, 0, 0, 1, 0, 0)">
	<path class="st7" d="M283.4,156c0-13.5-2.6-26.3-7.4-38.1l-9.3,3.7l-1.7,0.7l-6.4,2.5l-1.7,0.7l-6.9,2.8l-1.7,0.7l-7.3,2.9&#10;&#9;&#9;l-1.7,0.7l-7.3,2.9l-1.7,0.7l-48.8,19.5l50,16.1l1.8,0.6l7.5,2.4l1.8,0.6l7.5,2.4l1.8,0.6l7.1,2.3l1.8,0.6l6.6,2.1l1.8,0.6l9.8,3.1&#10;&#9;&#9;C281.8,177.2,283.4,166.8,283.4,156z" style="fill: rgb(70, 83, 100);"/>
	<path class="st7" d="M96,189.7l1.7-0.7l6.4-2.5l1.7-0.7l6.9-2.8l1.7-0.7l7.3-2.9l1.7-0.7l7.3-2.9l1.7-0.7l48.8-19.5l-50-16.1&#10;&#9;&#9;l-1.8-0.6l-7.5-2.4l-1.8-0.6l-7.5-2.4l-1.8-0.6l-7.1-2.3l-1.8-0.6l-6.6-2.1l-1.8-0.6l-9.8-3.1c-3.2,10-5,20.6-5,31.6&#10;&#9;&#9;c0,13.3,2.6,25.9,7.2,37.6L96,189.7z" style="fill: rgb(70, 83, 100);"/>
	<g>
	<path class="st8" d="M276.1,117.9c-15.1-37.5-51.9-64-94.8-64c-45.4,0-83.8,29.6-97.2,70.6l97.3,31.3L276.1,117.9z" style="fill: rgb(1, 35, 60);"/>
	<path class="st8" d="M181.3,258.2c45.7,0,84.3-30,97.4-71.3l-97.3-31.2l-95.1,37.9C101.2,231.5,138.1,258.2,181.3,258.2z" style="fill: rgb(1, 35, 60);"/>
	<path class="st9" d="M181.4,72.5c35,0,65,21.7,77.2,52.4l6.4-2.5c-13.3-33.2-45.8-56.7-83.6-56.7c-40.1,0-74.1,26.3-85.7,62.5&#10;&#9;&#9;&#9;l6.6,2.1C113,96.8,144.4,72.5,181.4,72.5z" style="fill: none;"/>
	<path class="st9" d="M181.4,238.9c-35,0-65-21.7-77.2-52.4l-6.4,2.5c13.3,33.2,45.8,56.7,83.6,56.7c40.1,0,74.1-26.3,85.7-62.5&#10;&#9;&#9;&#9;l-6.6-2.1C249.8,214.6,218.4,238.9,181.4,238.9z" style="fill: none;"/>
	<path class="st9" d="M181.4,91.5c27,0,50.1,16.7,59.6,40.4l7.3-2.9c-10.6-26.5-36.6-45.3-66.9-45.3c-32,0-59.2,21-68.6,50l7.5,2.4&#10;&#9;&#9;&#9;C128.6,110.3,152.9,91.5,181.4,91.5z" style="fill: none;"/>
	<path class="st9" d="M181.4,219.8c-27,0-50.1-16.7-59.6-40.4l-7.3,2.9c10.6,26.5,36.6,45.4,66.9,45.4c32,0,59.2-21,68.6-50&#10;&#9;&#9;&#9;l-7.5-2.4C234.1,201.1,209.9,219.8,181.4,219.8z" style="fill: none;"/>
	<path class="st9" d="M181.4,229.6c-31.1,0-57.7-19.3-68.6-46.5l-6.9,2.8c12,30,41.3,51.2,75.5,51.2c36.2,0,66.9-23.7,77.4-56.5&#10;&#9;&#9;&#9;l-7.1-2.3C242.2,208,214.3,229.6,181.4,229.6z" style="fill: none;"/>
	<path class="st9" d="M181.4,81.8c31.1,0,57.7,19.3,68.6,46.5l6.9-2.8c-12-30-41.3-51.2-75.5-51.2c-36.2,0-66.9,23.7-77.4,56.5&#10;&#9;&#9;&#9;l7.1,2.3C120.6,103.4,148.5,81.8,181.4,81.8z" style="fill: none;"/>
	<path class="st9" d="M181.4,101.3c22.9,0,42.5,14.2,50.5,34.2l7.3-2.9c-9.2-23-31.6-39.2-57.8-39.2c-27.7,0-51.2,18.2-59.3,43.2&#10;&#9;&#9;&#9;l7.5,2.4C136.7,117.2,157.2,101.3,181.4,101.3z" style="fill: none;"/>
	<path class="st9" d="M230.2,136.2c-7.7-19.4-26.7-33.1-48.8-33.1c-23.4,0-43.2,15.3-50,36.5l50,16.1L230.2,136.2z" style="fill: none;"/>
	<path class="st9" d="M132.6,175.1c7.7,19.4,26.7,33.1,48.8,33.1c23.4,0,43.2-15.3,50-36.5l-50-16.1L132.6,175.1z" style="fill: none;"/>
	<path class="st9" d="M181.4,210.1c-22.9,0-42.5-14.2-50.5-34.2l-7.3,2.9c9.2,23,31.6,39.2,57.8,39.2c27.7,0,51.2-18.2,59.3-43.2&#10;&#9;&#9;&#9;l-7.5-2.4C226.1,194.2,205.6,210.1,181.4,210.1z" style="fill: none;"/>
	<path class="st10" d="M181.4,65.6c37.9,0,70.3,23.5,83.6,56.7l1.7-0.7c-13.6-33.9-46.7-57.9-85.4-57.9&#10;&#9;&#9;&#9;c-40.9,0-75.6,26.8-87.5,63.8l1.8,0.6C107.3,91.9,141.3,65.6,181.4,65.6z" style="fill: rgb(1, 51, 87);"/>
	<path class="st10" d="M181.4,247.6c40.9,0,75.6-26.8,87.5-63.8l-1.8-0.6c-11.7,36.2-45.7,62.5-85.7,62.5&#10;&#9;&#9;&#9;c-37.9,0-70.3-23.5-83.6-56.7l-1.7,0.7C109.6,223.6,142.7,247.6,181.4,247.6z" style="fill: rgb(1, 51, 87);"/>
	<path class="st11" d="M271.5,155.7c0,9.6-1.5,18.9-4.3,27.5l1.8,0.6c2.9-8.9,4.4-18.3,4.4-28.1c0-12-2.3-23.5-6.6-34l-1.7,0.7&#10;&#9;&#9;&#9;C269.2,132.6,271.5,143.9,271.5,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st11" d="M91.3,155.7c0-9.6,1.5-18.9,4.3-27.5l-1.8-0.6c-2.9,8.9-4.4,18.3-4.4,28.1c0,12,2.3,23.5,6.6,34l1.7-0.7&#10;&#9;&#9;&#9;C93.6,178.7,91.3,167.5,91.3,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st10" d="M181.4,237c-34.2,0-63.5-21.2-75.5-51.2l-1.7,0.7c12.3,30.7,42.3,52.4,77.2,52.4c37,0,68.4-24.3,79.2-57.7&#10;&#9;&#9;&#9;l-1.8-0.6C248.3,213.2,217.6,237,181.4,237z" style="fill: rgb(1, 51, 87);"/>
	<path class="st10" d="M181.4,72.5c-37,0-68.4,24.3-79.2,57.7l1.8,0.6c10.5-32.7,41.2-56.5,77.4-56.5c34.2,0,63.5,21.2,75.5,51.2&#10;&#9;&#9;&#9;l1.7-0.7C246.4,94.2,216.4,72.5,181.4,72.5z" style="fill: rgb(1, 51, 87);"/>
	<path class="st11" d="M262.7,155.7c0,8.7-1.4,17-3.9,24.9l1.8,0.6c2.6-8,4-16.6,4-25.4c0-10.9-2.1-21.3-5.9-30.8l-1.7,0.7&#10;&#9;&#9;&#9;C260.6,134.9,262.7,145,262.7,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st11" d="M100.1,155.7c0-8.7,1.4-17,3.9-24.9l-1.8-0.6c-2.6,8-4,16.6-4,25.4c0,10.9,2.1,21.3,5.9,30.8l1.7-0.7&#10;&#9;&#9;&#9;C102.2,176.5,100.1,166.3,100.1,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st10" d="M181.4,83.6c30.3,0,56.3,18.8,66.9,45.3l1.7-0.7c-10.9-27.2-37.5-46.5-68.6-46.5&#10;&#9;&#9;&#9;c-32.9,0-60.8,21.6-70.3,51.3l1.8,0.6C122.2,104.7,149.4,83.6,181.4,83.6z" style="fill: rgb(1, 51, 87);"/>
	<path class="st10" d="M181.4,229.6c32.9,0,60.8-21.6,70.3-51.3l-1.8-0.6c-9.3,29-36.5,50-68.6,50c-30.3,0-56.3-18.8-66.9-45.4&#10;&#9;&#9;&#9;l-1.7,0.7C123.7,210.3,150.3,229.6,181.4,229.6z" style="fill: rgb(1, 51, 87);"/>
	<path class="st11" d="M253.4,155.7c0,7.7-1.2,15.1-3.5,22l1.8,0.6c2.3-7.1,3.5-14.7,3.5-22.6c0-9.7-1.9-18.9-5.3-27.4l-1.7,0.7&#10;&#9;&#9;&#9;C251.6,137.3,253.4,146.2,253.4,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st11" d="M109.4,155.7c0-7.7,1.2-15.1,3.5-22l-1.8-0.6c-2.3,7.1-3.5,14.7-3.5,22.6c0,9.7,1.9,18.9,5.3,27.4l1.7-0.7&#10;&#9;&#9;&#9;C111.2,174.1,109.4,165.1,109.4,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st10" d="M181.4,217.9c-26.2,0-48.6-16.3-57.8-39.2l-1.7,0.7c9.5,23.6,32.6,40.4,59.6,40.4&#10;&#9;&#9;&#9;c28.5,0,52.8-18.7,61.1-44.5l-1.8-0.6C232.6,199.8,209.1,217.9,181.4,217.9z" style="fill: rgb(1, 51, 87);"/>
	<path class="st10" d="M181.4,91.5c-28.5,0-52.7,18.7-61.1,44.5l1.8,0.6c8.1-25.1,31.6-43.2,59.3-43.2c26.2,0,48.6,16.3,57.8,39.2&#10;&#9;&#9;&#9;l1.7-0.7C231.5,108.3,208.4,91.5,181.4,91.5z" style="fill: rgb(1, 51, 87);"/>
	<path class="st11" d="M243.7,155.7c0,6.6-1.1,13-3,19l1.8,0.6c2-6.2,3.1-12.8,3.1-19.6c0-8.4-1.6-16.4-4.6-23.8l-1.7,0.7&#10;&#9;&#9;&#9;C242.1,139.7,243.7,147.5,243.7,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st11" d="M119.1,155.7c0-6.6,1.1-13,3-19l-1.8-0.6c-2,6.2-3.1,12.8-3.1,19.6c0,8.4,1.6,16.4,4.6,23.8l1.7-0.7&#10;&#9;&#9;&#9;C120.7,171.6,119.1,163.8,119.1,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st10" d="M181.4,210.1c24.2,0,44.7-15.9,51.8-37.8l-1.8-0.6c-6.8,21.1-26.6,36.5-50,36.5c-22.1,0-41-13.7-48.8-33.1&#10;&#9;&#9;&#9;l-1.7,0.7C138.9,195.9,158.5,210.1,181.4,210.1z" style="fill: rgb(1, 51, 87);"/>
	<path class="st10" d="M181.4,103.1c22.1,0,41,13.7,48.8,33.1l1.7-0.7c-8-20-27.6-34.2-50.5-34.2c-24.2,0-44.7,15.9-51.8,37.8&#10;&#9;&#9;&#9;l1.8,0.6C138.2,118.5,158,103.1,181.4,103.1z" style="fill: rgb(1, 51, 87);"/>
	<path class="st11" d="M233.9,155.7c0,5.6-0.9,11-2.5,16.1l1.8,0.6c1.7-5.2,2.6-10.8,2.6-16.6c0-7.1-1.4-13.9-3.9-20.1l-1.7,0.7&#10;&#9;&#9;&#9;C232.6,142.2,233.9,148.8,233.9,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path class="st11" d="M128.9,155.7c0-5.6,0.9-11,2.5-16.1l-1.8-0.6c-1.7,5.2-2.6,10.8-2.6,16.6c0,7.1,1.4,13.9,3.9,20.1l1.7-0.7&#10;&#9;&#9;&#9;C130.2,169.1,128.9,162.5,128.9,155.7z" style="fill: rgb(79, 95, 115);"/>
	<path d="M 227.600002 156 A 46.299999 46.299999 0 0 1 181.300003 202.299999 A 46.299999 46.299999 0 0 1 135.000004 156 A 46.299999 46.299999 0 0 1 181.300003 109.700001 A 46.299999 46.299999 0 0 1 227.600002 156 Z" class="st12" style="fill: rgb(5, 2, 0);"/>
	<path d="M 218.800003 156 A 37.5 37.5 0 0 1 181.300003 193.5 A 37.5 37.5 0 0 1 143.800003 156 A 37.5 37.5 0 0 1 181.300003 118.5 A 37.5 37.5 0 0 1 218.800003 156 Z" class="st4" style="fill: rgb(0, 170, 188);"/>
	<path d="M 189.500003 156 A 8.2 8.2 0 0 1 181.300003 164.2 A 8.2 8.2 0 0 1 173.100003 156 A 8.2 8.2 0 0 1 181.300003 147.8 A 8.2 8.2 0 0 1 189.500003 156 Z" class="st2" style="fill: rgb(255, 255, 255);"/>
	</g>
	</g></g></svg>
	`)

export default async function handler(
	req: VercelRequest,
	res: VercelResponse
) {
	const API_KEY = process.env.LASTFM_API_KEY
	const USER = process.env.LASTFM_USER

	if (!API_KEY || !USER) {
		res.status(500).send("Missing Last.fm env vars")
		return
	}

	const r = await fetch(
		`https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${USER}&api_key=${API_KEY}&format=json&limit=1`
	)

	const data = await r.json()
	const track = data.recenttracks.track[0]

	const title = track.name
	const artist = track.artist["#text"]
	const playing = track["@attr"]?.nowplaying === "true"

	let image = PLACEHOLDER

	const artUrl =
	track.image?.find((i: any) => i.size === "extralarge")?.["#text"] ||
	track.image?.find((i: any) => i.size === "large")?.["#text"]

	if (artUrl) {
		image = await fetchAsDataURL(artUrl)
	}
	const subtitle = playing
	? "currently listening to": `last played ${timeAgo(track.date.uts)} ago`

	res.setHeader("Content-Type", "image/svg+xml")
	res.setHeader(
		"Cache-Control",
		"public, max-age=0, s-maxage=30, stale-while-revalidate=300"
	)

	res.status(200).send(svg(title, artist, subtitle, playing, image))
}

	function timeAgo(uts: string) {
		const diff = Math.floor((Date.now() - Number(uts) * 1000) / 1000)
		if (diff < 60) return "just now"
		if (diff < 3600) return `${Math.floor(diff / 60)} min`
		if (diff < 86400) return `${Math.floor(diff / 3600)} hr`
		return `${Math.floor(diff / 86400)} day`
	}

	function svg(
		title: string,
		artist: string,
		subtitle: string,
		playing: boolean,
		image: string
	) {
		return `
		<svg width="420" height="70" viewBox="0 0 420 70"
		xmlns="http://www.w3.org/2000/svg">

		<style>
		text { fill:#cdd6f4;font:14px monospace }
		.sub { fill:#a6adc8;font-size:12px }
		.meta { fill:#89b4fa;font-size:11px }
		</style>

		<defs>
		<clipPath id="c">
		<rect x="8" y="8" width="54" height="54" rx="6"/>
		</clipPath>
		</defs>

		<image href="${image}"
		x="8" y="8"
		width="54" height="54"
		clip-path="url(#c)"
		preserveAspectRatio="xMidYMid slice"/>

		<text x="72" y="18" class="meta">${escape(subtitle)}</text>
		<text x="72" y="38">ðŸŽ§ ${escape(title)}</text>
		<text x="72" y="56" class="sub">${escape(artist)}</text>

		${playing ? pulse(): ""}
		</svg>`
	}

	function pulse() {
		return `
		<circle cx="390" cy="35" r="6" fill="#a6e3a1">
		<animate attributeName="r" values="6;10;6"
		dur="1.2s" repeatCount="indefinite"/>
		<animate attributeName="opacity" values="1;.4;1"
		dur="1.2s" repeatCount="indefinite"/>
		</circle>`
	}

	function escape(s: string) {
		return s.replace(/[&<>]/g, c =>
			({
				"&": "&amp;", "<": "&lt;", ">": "&gt;"
			}[c]!)
		)
	}

	async function fetchAsDataURL(url: string) {
		const r = await fetch(url)
		const buf = Buffer.from(await r.arrayBuffer())
		const mime = r.headers.get("content-type") || "image/jpeg"
		return `data:${mime};base64,${buf.toString("base64")}`
	}